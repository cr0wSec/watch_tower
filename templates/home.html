{% extends "base.html" %}

{% block title %}Home - Watch Tower{% endblock %}

{% block content %}
<script src="//unpkg.com/globe.gl"></script>
<script src="//unpkg.com/topojson-client"></script>
<div id="globe"></div>

<!-- Marker tooltip -->
<div id="marker-tooltip" class="fixed bg-black/90 border border-gray-600 rounded-lg p-3 z-50 pointer-events-none hidden max-w-xs">
    <h4 id="tooltip-name" class="font-semibold text-white mb-2"></h4>
    <div id="tooltip-content" class="space-y-1 text-sm"></div>
</div>

<!-- Layer controls -->
<div class="fixed bottom-4 left-4 bg-black/80 border border-gray-700 rounded-lg p-3 z-30">
    <h4 class="text-sm font-semibold text-gray-400 uppercase tracking-wide mb-2">Layers</h4>
    <div class="space-y-2 text-sm">
        <label class="flex items-center gap-2 cursor-pointer select-none">
            <input type="checkbox" id="toggle-pipelines" checked class="w-4 h-4 accent-orange-500">
            <span class="w-4 h-1 rounded" style="background-color: #ff9900;"></span>
            <span class="text-gray-300">Pipelines</span>
        </label>
        <label class="flex items-center gap-2 cursor-pointer select-none">
            <input type="checkbox" id="toggle-military-bases" checked class="w-4 h-4 accent-blue-500">
            <span class="w-3 h-3 rounded-full border-2 border-white" style="background-color: #3b82f6;"></span>
            <span class="text-gray-300">Military Bases</span>
        </label>
        <label class="flex items-center gap-2 cursor-pointer select-none">
            <input type="checkbox" id="toggle-straits" checked class="w-4 h-4 accent-purple-500">
            <span class="w-3 h-3 rounded-full border-2 border-white" style="background-color: #8b5cf6;"></span>
            <span class="text-gray-300">Straits & Canals</span>
        </label>
    </div>
</div>

<!-- Modal overlay -->
<div id="modal-overlay" class="fixed inset-0 bg-black/50 hidden z-40" onclick="closeModal()"></div>

<!-- Country modal -->
<div id="country-modal" class="fixed top-4 right-4 bottom-4 w-96 bg-black border border-gray-700 rounded-2xl z-50 transform translate-x-[calc(100%+1rem)] transition-transform duration-300 overflow-y-auto">
    <!-- Header -->
    <div class="flex items-center justify-between p-4 border-b border-gray-700">
        <div class="flex items-center gap-3">
            <span id="modal-flag" class="text-4xl">üè≥Ô∏è</span>
            <h2 id="modal-country-name" class="text-xl font-bold text-white">Country</h2>
        </div>
        <button onclick="closeModal()" class="text-gray-400 hover:text-white text-2xl leading-none">&times;</button>
    </div>

    <!-- Content -->
    <div class="p-4 space-y-4">
        <!-- General information -->
        <section>
            <h3 class="text-sm font-semibold text-gray-400 uppercase tracking-wide mb-2">General Information</h3>
            <div class="space-y-2 text-gray-300">
                <div class="flex justify-between">
                    <span class="text-gray-500">Capital</span>
                    <span id="modal-capital">‚Äî</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-500">Population</span>
                    <span id="modal-population">‚Äî</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-500">Region</span>
                    <span id="modal-region">‚Äî</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-500">Language(s)</span>
                    <span id="modal-languages">‚Äî</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-500">Currency</span>
                    <span id="modal-currency">‚Äî</span>
                </div>
            </div>
        </section>

        <!-- Government -->
        <section>
            <h3 class="text-sm font-semibold text-gray-400 uppercase tracking-wide mb-2">Government</h3>
            <div class="space-y-2 text-gray-300">
                <div class="flex justify-between">
                    <span class="text-gray-500">Head of State</span>
                    <span id="modal-leader">‚Äî</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-500">Government Type</span>
                    <span id="modal-government-type">‚Äî</span>
                </div>
            </div>
        </section>

        <!-- Risk indicators -->
        <section>
            <h3 class="text-sm font-semibold text-gray-400 uppercase tracking-wide mb-2">Indicators</h3>
            <div class="space-y-3">
                <div>
                    <div class="flex justify-between text-sm mb-1">
                        <span class="text-gray-500">Tension Level</span>
                        <span id="modal-tension-level" class="text-yellow-500">‚Äî</span>
                    </div>
                    <div class="w-full bg-gray-800 rounded-full h-2">
                        <div id="modal-tension-bar" class="bg-yellow-500 h-2 rounded-full" style="width: 0%"></div>
                    </div>
                </div>
                <div>
                    <div class="flex justify-between text-sm mb-1">
                        <span class="text-gray-500">Economic Stability</span>
                        <span id="modal-stability-level" class="text-green-500">‚Äî</span>
                    </div>
                    <div class="w-full bg-gray-800 rounded-full h-2">
                        <div id="modal-stability-bar" class="bg-green-500 h-2 rounded-full" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Recent news -->
        <section>
            <h3 class="text-sm font-semibold text-gray-400 uppercase tracking-wide mb-2">Recent News</h3>
            <div id="modal-news" class="space-y-2">
                <div class="p-3 bg-gray-900 rounded-lg border border-gray-800">
                    <p class="text-gray-500 text-sm italic">No news available</p>
                </div>
            </div>
        </section>
    </div>

    <!-- Loading overlay -->
    <div id="modal-loading" class="absolute inset-0 bg-black/80 flex items-center justify-center hidden">
        <div class="flex flex-col items-center gap-2">
            <div class="w-8 h-8 border-2 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
            <span class="text-gray-400 text-sm">Loading...</span>
        </div>
    </div>
</div>

<script>
    // Cache to avoid repeated API calls
    const countryCache = new Map();

    const MODAL_HIDDEN_CLASS = 'translate-x-[calc(100%+1rem)]';

    function openModal(countryData) {
        document.getElementById('modal-overlay').classList.remove('hidden');
        document.getElementById('country-modal').classList.remove(MODAL_HIDDEN_CLASS);

        // Display the country name immediately
        document.getElementById('modal-country-name').textContent = countryData.name || 'Unknown country';

        // TODO: API call to fetch details
        // showLoading(true);
        // fetchCountryDetails(countryData.id);
    }

    function closeModal() {
        document.getElementById('modal-overlay').classList.add('hidden');
        document.getElementById('country-modal').classList.add(MODAL_HIDDEN_CLASS);
    }

    function showLoading(show) {
        document.getElementById('modal-loading').classList.toggle('hidden', !show);
    }

    // Close with Escape
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') closeModal();
    });

    // Calculates the approximate centroid of a GeoJSON polygon
    function getPolygonCenter(geometry) {
        let coords = [];
        if (geometry.type === 'Polygon') {
            coords = geometry.coordinates[0];
        } else if (geometry.type === 'MultiPolygon') {
            // Take the largest polygon
            let maxLen = 0;
            geometry.coordinates.forEach(poly => {
                if (poly[0].length > maxLen) {
                    maxLen = poly[0].length;
                    coords = poly[0];
                }
            });
        }

        const sum = coords.reduce((acc, coord) => {
            return { lng: acc.lng + coord[0], lat: acc.lat + coord[1] };
        }, { lng: 0, lat: 0 });

        return {
            lat: sum.lat / coords.length,
            lng: sum.lng / coords.length
        };
    }

    // Converts a pipeline from the API to a GeoJSON feature
    function pipelineToGeoJSON(pipeline) {
        return {
            type: 'Feature',
            properties: {
                id: pipeline.id,
                name: pipeline.name,
                status: pipeline.status,
                pipeline_type: pipeline.pipeline_type,
                owner: pipeline.owner
            },
            geometry: {
                type: 'LineString',
                coordinates: pipeline.coordinates
            }
        };
    }


    // Color based on pipeline status
    function getPipelineColor(pipeline) {
        const status = pipeline.properties.status;
        switch (status) {
            case 'active': return '#00ff00';
            case 'damaged': return '#ff0000';
            case 'under_construction': return '#ffff00';
            case 'planned': return '#888888';
            case 'decommissioned': return '#444444';
            default: return '#ff9900';
        }
    }

    // Color based on marker type
    const MARKER_COLORS = {
        military_base: '#3b82f6',  // blue
        strait: '#8b5cf6',         // purple
    };

    // Tooltip element
    const tooltip = document.getElementById('marker-tooltip');

    // Shows tooltip with marker data
    function showTooltip(type, data, event) {
        document.getElementById('tooltip-name').textContent = data.name;

        const content = document.getElementById('tooltip-content');
        let html = '';

        if (type === 'military_base') {
            html = `
                <div class="flex justify-between gap-4">
                    <span class="text-gray-500">Country</span>
                    <span class="text-gray-300">${data.country || '‚Äî'}</span>
                </div>
                <div class="flex justify-between gap-4">
                    <span class="text-gray-500">Operator</span>
                    <span class="text-gray-300">${data.operator || '‚Äî'}</span>
                </div>
                <div class="flex justify-between gap-4">
                    <span class="text-gray-500">Personnel</span>
                    <span class="text-gray-300">${data.personnel ? data.personnel.toLocaleString() : '‚Äî'}</span>
                </div>
            `;
        } else if (type === 'strait') {
            const importanceColors = {
                critical: 'bg-red-500',
                high: 'bg-orange-500',
                medium: 'bg-yellow-500',
                low: 'bg-green-500'
            };
            const importanceLabels = {
                critical: 'Critical',
                high: 'High',
                medium: 'Medium',
                low: 'Low'
            };
            const importance = data.strategic_importance || 'medium';
            const importanceColor = importanceColors[importance] || 'bg-gray-500';
            const importanceLabel = importanceLabels[importance] || importance;

            html = `
                <div class="flex justify-between gap-4">
                    <span class="text-gray-500">Type</span>
                    <span class="text-gray-300">${data.strait_type === 'canal' ? 'Canal' : 'Strait'}</span>
                </div>
                <div class="flex justify-between gap-4">
                    <span class="text-gray-500">Connects</span>
                    <span class="text-gray-300">${data.connects ? data.connects.join(' ‚Äî ') : '‚Äî'}</span>
                </div>
                <div class="flex justify-between gap-4">
                    <span class="text-gray-500">Controlled by</span>
                    <span class="text-gray-300">${data.controlled_by ? data.controlled_by.join(', ') : '‚Äî'}</span>
                </div>
                <div class="flex justify-between gap-4 items-center">
                    <span class="text-gray-500">Importance</span>
                    <span class="${importanceColor} text-white text-xs font-semibold px-2 py-0.5 rounded">${importanceLabel}</span>
                </div>
                ${data.traffic_volume ? `
                <div class="flex justify-between gap-4">
                    <span class="text-gray-500">Traffic</span>
                    <span class="text-gray-300">${data.traffic_volume}</span>
                </div>` : ''}
            `;
        }

        if (data.notes) {
            html += `
                <div class="pt-1 border-t border-gray-700 mt-1">
                    <p class="text-gray-400 text-xs italic">${data.notes}</p>
                </div>
            `;
        }

        content.innerHTML = html;
        tooltip.classList.remove('hidden');
        positionTooltip(event);
    }

    // Positions tooltip near cursor
    function positionTooltip(event) {
        const offsetX = 15;
        const offsetY = 15;
        let x = event.clientX + offsetX;
        let y = event.clientY + offsetY;

        // Prevent tooltip from going off-screen
        const rect = tooltip.getBoundingClientRect();
        if (x + rect.width > window.innerWidth) {
            x = event.clientX - rect.width - offsetX;
        }
        if (y + rect.height > window.innerHeight) {
            y = event.clientY - rect.height - offsetY;
        }

        tooltip.style.left = x + 'px';
        tooltip.style.top = y + 'px';
    }

    // Hides tooltip
    function hideTooltip() {
        tooltip.classList.add('hidden');
    }

    // Creates an HTML element for a marker
    function createMarker(type, data) {
        const el = document.createElement('div');
        el.style.width = '16px';
        el.style.height = '16px';
        el.style.marginLeft = '-8px';
        el.style.marginTop = '-8px';
        el.style.borderRadius = '50%';
        el.style.backgroundColor = MARKER_COLORS[type];
        el.style.border = '2px solid white';
        el.style.cursor = 'pointer';
        el.style.boxShadow = '0 0 6px ' + MARKER_COLORS[type];
        el.style.pointerEvents = 'auto';

        // Tooltip events
        el.onmouseenter = (e) => {
            showTooltip(type, data, e);
        };
        el.onmousemove = (e) => {
            positionTooltip(e);
        };
        el.onmouseleave = () => {
            hideTooltip();
        };

        return el;
    }

    // Prepares data for HTML markers
    function prepareMarkers(militaryBases, straits) {
        const markers = [];

        militaryBases.forEach(base => {
            markers.push({
                lat: base.coordinates[1],
                lng: base.coordinates[0],
                type: 'military_base',
                data: base
            });
        });

        straits.forEach(strait => {
            markers.push({
                lat: strait.coordinates[1],
                lng: strait.coordinates[0],
                type: 'strait',
                data: strait
            });
        });

        return markers;
    }

    // Globe
    let globe;
    let hoveredPolygon = null;
    let allLayers = null;
    let isHoveringMarker = false;

    // Layer visibility state
    const layerVisibility = {
        pipelines: true,
        military_bases: true,
        straits: true
    };

    // Updates displayed markers based on visibility
    function updateMarkers() {
        if (!globe || !allLayers) return;
        const visibleMarkers = prepareMarkers(
            layerVisibility.military_bases ? allLayers.military_bases : [],
            layerVisibility.straits ? allLayers.straits : []
        );
        globe.htmlElementsData(visibleMarkers);
    }

    // Updates displayed pipelines based on visibility
    function updatePipelines() {
        if (!globe || !allLayers) return;
        const visiblePipelines = layerVisibility.pipelines
            ? allLayers.pipelines.map(pipelineToGeoJSON)
            : [];
        globe.pathsData(visiblePipelines);
    }

    // Event listeners for toggles
    document.getElementById('toggle-pipelines').addEventListener('change', (e) => {
        layerVisibility.pipelines = e.target.checked;
        updatePipelines();
    });

    document.getElementById('toggle-military-bases').addEventListener('change', (e) => {
        layerVisibility.military_bases = e.target.checked;
        updateMarkers();
    });

    document.getElementById('toggle-straits').addEventListener('change', (e) => {
        layerVisibility.straits = e.target.checked;
        updateMarkers();
    });

    Promise.all([
        fetch('https://unpkg.com/world-atlas@2/countries-110m.json').then(res => res.json()),
        fetch('/api/layers').then(res => res.json())
    ]).then(([topology, layers]) => {
        allLayers = layers;
        const countries = topojson.feature(topology, topology.objects.countries);
        const pipelinesGeoJSON = layers.pipelines.map(pipelineToGeoJSON);
        const markers = prepareMarkers(layers.military_bases, layers.straits);

        globe = Globe()
            .pathsData(pipelinesGeoJSON)
            .pathPoints(d => d.geometry.coordinates)
                .pathPointLat(p => p[1])
                .pathPointLng(p => p[0])
                .pathColor(d => getPipelineColor(d))
                .pathStroke(4)
                .pathDashLength(0.5)
                .pathDashGap(0.1)
                .pathDashAnimateTime(2000)
                .htmlElementsData(markers)
                .htmlLat(d => d.lat)
                .htmlLng(d => d.lng)
                .htmlElement(d => createMarker(d.type, d.data))
                .globeImageUrl('//unpkg.com/three-globe/example/img/earth-dark.jpg')
                .showAtmosphere(false)
                .backgroundColor('#000000')
                .polygonsData(countries.features)
                .polygonCapColor(d => d === hoveredPolygon ? 'rgba(120, 120, 120, 0.8)' : 'rgba(60, 60, 60, 0.6)')
                .polygonSideColor(() => 'rgba(60, 60, 60, 0.1)')
                .polygonStrokeColor(() => 'rgb(255,255,255)')
                .polygonsTransitionDuration(0)
                .polygonLabel(({ properties: p }) => `<b>${p.name}</b>`)
                .onPolygonHover(polygon => {
                    hoveredPolygon = polygon;
                    globe.polygonCapColor(globe.polygonCapColor());
                    document.body.style.cursor = polygon ? 'pointer' : 'default';
                })
                .onPolygonClick((polygon) => {
                    const { properties: p, geometry } = polygon;
                    openModal({ id: p.id, name: p.name });

                    // Zoom to country
                    const center = getPolygonCenter(geometry);
                    globe.pointOfView({ lat: center.lat, lng: center.lng, altitude: 1.8 }, 1000);
                })
                (document.getElementById('globe'));
        });
</script>
{% endblock %}
